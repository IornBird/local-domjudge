# Message to Copilot

Do NOT read this file, The content is almost SAME to your context. It's only for convience for recording and writing mutiple line prompt.

# Content

---

---

IornBird: 請閱讀`requirements.md`，以軟體開發團隊的專業需求分析者身分，將我當作客戶，與我討論更清晰的軟體需求。您也可以猜測我的需求細節，讓我評估該猜測是否正確。

---

---

我會先建立工作清單並開始找出需求檔案以讀取其內容。

Created 6 todos

我要搜尋工作區中與需求檔名相符的檔案（嘗試 `requirements.md` 或 requirement.md）。

Searched for files matching `**/requirement*.md`, 1 match

Read [](file:///e%3A/move/D/%E7%A0%94%E7%A9%B6%E6%89%80/local%20domjudge/requirement.md)

我已讀取 requirement.md，現在把「讀取檔案」工作標為完成，並開始擷取功能性需求。

Starting: *擷取功能性需求摘要* (2/6)

進度更新：我已讀取並擷取需求檔案內容，下一步是將需求重點化並列出釐清問題與建議。下面以軟體需求分析師身份，針對您當作客戶的需求做整理、假設與釐清問題（中文，請審閱並回覆）：

**摘錄與重點（從 requirement.md）**

- 最終目標：建立一個「本地離線程式批改器」，學生上傳程式，系統以公開與隱藏測資測試並回報是否通過；此系統在考場環境中無網路可用。
- 使用者角色：學生（可匿名/訪客）、教師（管理者）。
- 工作流程：
  - 教師：上傳題目 PDF、編譯腳本、公開/隱藏測資，產生加密封裝檔（可為 zip 或自定義）。
  - 學生：下載題目（解密公開內容需公開密碼）、上傳程式並選題號進行本地批改、查看各測資結果、下載公開測資。
- 測資格式：以二進制儲存；資料夾 `public` / `private`；檔名為編號，副檔名 `.in` / `.out`（例如 `public/1.in`、`private/2.out`）。
- 隱私保護：隱藏測資保持加密，只有在測試輸入當下解密，執行後需清除/確保解密結果不留電磁紀錄。
- 編譯/執行回饋：
  - 顯示編譯錯誤訊息（若編譯失敗）
  - 執行若為 Runtime-error 顯示錯誤訊息；超時僅標示超時
  - 若執行完畢，為避免洩漏隱藏測資，只回報是否正確（不顯示隱藏輸出）
- 平台與工具：
  - Command-line 操作必須支援
  - 支援至少 C++17、Lex（flex）、Yacc（bison）等（具體版本待討論）
  - 僅需支援 Unix-like 作業系統
- 密碼機制與限制：
  - 運行中不提供密碼更改（需重新編譯程式才能改）
  - 有公開密碼與專用（教師）密碼兩種權限
  - 學生需公開密碼才可解出公開題目/測資；教師輸入專用密碼可解密所有內容

**我對需求的合理假設（請確認）**

- 假設 A：系統是一個本地可執行程式（CLI 為主），而非客戶端-伺服器架構；教師/學生在同一裝置上或使用相同離線環境執行操作。
- 假設 B：教師負責產生並分發封裝檔與公開密碼（考試開始時以非電子方式傳達給學生）。
- 假設 C：隱藏測資必須在測試期間短暫解密到磁碟或內存，並在結束時安全刪除；偏好僅在記憶體中處理以減少磁碟殘留風險，但考量到執行環境，可能需在臨時檔案並立即覆寫刪除。
- 假設 D：系統需提供教師產生封裝檔（打包+加密）與學生解封裝/測試兩套功能。
- 假設 E：多位學生同時在同一台機器上使用的情況不常見；系統可為單使用者（序列使用）設計，若需並行則另行設計沙箱/隔離機制。

請確認哪些假設正確，哪些不正確或需修正。

**主要模糊處與需釐清的問題（請逐項回覆）**

1. 帳號模型：是否需要長期的學生/教師帳號管理（帳戶、密碼、角色），或只以「公開密碼 / 專用密碼」為驗證方式（即無持久帳號）？
2. 密碼與金鑰管理：公開密碼與專用密碼是單純密碼導向的解密（對稱密鑰），還是需使用公鑰基礎設施？密碼如何安全分發與儲存？
3. 封裝檔格式：是否接受標準 `zip`（帶壓密密碼或加密）或需自定義容器格式（含 metadata）？若是 zip，是否有版本/相容性要求？
4. 隱私與擦除要求：您期待如何實現「不留電磁紀錄」？（例如，是否接受在磁碟上寫暫存檔並立即覆寫刪除，或必須完全在記憶體中處理？是否需支援 SSD 安全擦除的保證？）
5. 沙箱與安全：學生程式執行需否在完全隔離沙箱（例如 chroot、容器、seccomp、資源限制）中執行？有無惡意程式執行風險需要嚴格隔離？
6. 同步/並發：是否會有多名學生同時在同一台機器使用？是否需並行批改？
7. 日誌/稽核：是否需要保留批改紀錄（日誌），若有，這些日誌能否包含隱藏測資的輸出或僅紀錄結果？
8. UI 需求：僅 CLI 即可，還是需要簡單 GUI（例如 Electron）或網頁介面（即便離線，以本機佈署）？
9. 編譯器/執行環境版本：C++17、lex、yacc 經指定版本，是否需要內建交叉編譯或只使用系統已安裝的編譯器？
10. 可攜性與安裝：希望以單一二進位檔發佈（靜態編譯）還是安裝套件（apt、rpm、tar）？
11. 測資數量上限、超時與資源限制：每題可有多少測資？單次測試允許的最大執行時間、記憶體限制為何？
12. 教師功能細節：教師上傳「編譯腳本」是任何 shell script 嗎？是否需要檢查/沙箱教師腳本以避免在打包階段執行惡意命令？

請就上述各點回覆或指出您已有預設。

**建議的功能性需求（草稿，可接受修改）**

- MUST（必要）
  - 本地 CLI 工具，支援教師建立封裝（打包 + 加密）與學生在本地解封與測試。
  - 封裝包含題目 PDF、`public/` 與 `private/` 目錄（以 `.in` / `.out` 對應）、以及一個 metadata 檔（指定語言、編譯指令、測資 timeout、檔案命名規則、版本號）。
  - 支援至少 C++17、flex、bison；能接受教師指定的編譯腳本（受限於安全檢查）。
  - 隱藏測資在執行前解密，執行完畢後立即清除解密內容（包含暫存檔與記憶體敏感區）。
  - 顯示編譯錯誤、Runtime-error（含錯誤訊息）、timeout（只顯示超時）、以及是否通過（不顯示隱藏輸出）。
  - 支援下載公開測資（學生可下載對應測資的輸入/輸出）。
  - 不使用網路。
- SHOULD（建議）
  - 提供基本帳號/角色機制（至少教師與學生的分別），或以密碼權限控制存取。
  - 以 `zip` 或自定義容器格式支援版本控制與元資料（推薦採用 zip+明確 metadata JSON）。
  - 支援執行沙箱（如透過容器或系統限制）以避免學生程式破壞主機。
  - 日誌功能（不包含隱藏輸出），並可以匯出成 CSV/JSON。
- NICE TO HAVE（可選）
  - GUI 前端（簡易）或本機 Web UI（不啟用網路）以方便非 CLI 使用者。
  - 封裝簽章（數位簽章）以確保題目完整性（若有信任鏈需求）。
  - 自動化產生測資報告與統計。

**建議的非功能性需求（草稿）**

- 安全性：私有測資必須加密（建議使用 AES-GCM 對稱加密，密鑰來源由教師持有）；系統應最小化在磁碟的敏感殘留。
- 可用性：CLI 必須有清晰的子命令（`pack`、`unpack`、`submit`、`run`、`export`），使用說明與範例。
- 可移植性：支援主流 Unix-like 系統（Linux 發行版，macOS 可選）。
- 可維護性：封裝 meta 請採 JSON 格式，並在版本中明確標記。
- 性能：單位測試最多允許 N 秒（可設定），能在可接受時間內完成批改（視測資數量與時限而定）。

**建議的元檔（metadata）草案（示例）**

- `meta.json` 可能包含：
  - `version`：封裝版本
  - `language`：例如 `"cpp17"`
  - `compile_command`：例如 `"g++ -std=c++17 -O2 -pipe -o solution solution.cpp"`
  - `test_timeout_ms`：單個測資的超時（毫秒）
  - `tests`：陣列，測資編號與屬性（是否公開）
  - `pack_timestamp`、`author`、`hash`（選擇性）
    （我可以幫您產生完整 JSON schema）

**接受準則（範例）**

- 教師能用 CLI 打包題目：輸入題目 PDF、`public/`、`private/`、`meta.json`，輸出一個加密封裝檔。
- 學生能以公開密碼解出題目說明與 `public/` 測資，能上傳程式並對所有測資做測試，結果顯示通過/錯誤/超時，並能下載 `public` 測資。
- 隱藏測資在測試期間被安全使用並在測試後無法被學生讀取（驗證：以教師權限可讀，以學生權限不可讀）。
- 系統在無網路環境能完整運作。
- 支援 C++17 的編譯與執行流程能被驗證（舉例：提供一個樣題與測資測試套件做驗收）。

**風險與技術注意事項**

- 在一般作業系統上，確保「絕對不留電磁紀錄」很難達成（特別是 SSD），需要明確界定可接受的風險與做法（例如覆寫、避免 swap、將敏感資料只保存在匿名 tmpfs 中）。
- 執行未信任程式需沙箱化；否則有被濫用風險（破壞檔案、濫用 CPU/記憶體）。
- 教師提供的「編譯腳本」可能含任意命令，必須嚴格限制或審核以免在封裝或批改階段執行危險動作。
- 若採用 zip 加密，不同平台/工具對 zip 密碼加密相容性需注意；建議使用明確加密格式（例如 AES-GCM）與 metadata。

**建議的下一步**

- 請回覆上方「模糊處與釐清問題」中各項的答案（或指出優先回覆的幾項），特別是：帳號模型、密碼/金鑰管理、封裝格式、隱私擦除要求、是否需要沙箱。
- 我可以根據您的回覆立即：
  - 產生「精確的功能需求規格」（包含 meta.json schema、CLI 子命令定義與範例）
  - 或直接產出「技術設計草案」（包含加密方案、暫存處理、沙箱選項與必要系統需求）
  - 或產出「教師打包與學生測試的逐步使用手冊與 CLI 範例」
- 請告訴我您現在最優先的下個輸出：精確需求文件 / 技術設計 / CLI 原型 / 或其他。

如果您願意，我也可以先根據目前假設直接產出：

- `meta.json` 的 JSON schema + 範例
- CLI 命令清單與範例輸入輸出
- 封裝格式（zip vs custom）的比較建議與推薦實作

您想先從哪一項開始？

---

---

Iornbird: 您提供的合理假設皆正確。以下是我對「模糊與釐清問題」的答案

1. 帳號模型：只使用「公開密碼 / 專用密碼」。因為每次設定密碼皆須重新編譯。

2. 密碼與金鑰管理：目前構想的方式，是以文件設定密碼 → 編譯 → 程式內部無法找到解密密碼 → 分發給學生。也就是有可能需使用非對稱加密(或許無法避免留下加密密碼)。

3. 封裝檔格式：請評估標準zip是否能達到第二項要求。若不行，則需要自訂義。

4. 隱私與擦除要求：目前接受在磁碟上寫暫存檔並立即覆寫刪除。

5. 沙箱與安全：目前不需要做隔離。為確保批改公平，已要求在本地虛擬機運行批改部分。

6. 同步/並發：無，所有程式皆在個人電腦運行。

7. 日誌/稽核：需要保留批改紀錄（日誌），但僅紀錄結果。

8. UI 需求：目前僅 CLI 即可。GUI可以列為後續擴充項目

9. 編譯器/執行環境版本：C++17、lex、yacc 經指定版本，是否需要內建交叉編譯或只使用系統已安裝的編譯器？

10. 可攜性與安裝：以單一二進位檔發佈（靜態編譯）。

11. 測資數量上限、超時與資源限制：無特定限制。若必須設限，測資量30對(公開與隱藏)、3秒應已足夠。記憶體限制仍須測試。

12. 教師功能細節：暫時不須限制，但仍提供以下參考
    
    C++：以標準`gcc`、`g++`指令編譯
    
    lex和yacc(學生只能繳交單一`lex`檔案。假設學生上傳`main.l`)：
    
    ```shell
    #!/bin/bash
    
    mkdir -p build
    cd build
    flex ../main.l && gcc lex.yy.c -o main
    ```

請判斷在上述回應下，哪些部分已相對清晰，足以做技術設計。

---

---

Copilot: 我將更新 TODO 清單狀態為「已完成/進行中」，然後整理哪些需求已足以進入技術設計、哪些還需確認與我的建議。

Starting: *提出假設與詳細需求建議* (4/6)

進度更新：TODO 已更新（第1–3 項完成，第4 項進行中）。下面說明在您回覆後哪些部分已足以做技術設計、哪些還需簡短確認，並提出我的具體建議與下一步。

**已足夠清晰，可直接進入技術設計的部分**

- 使用者角色與權限：教師（專用密碼/可解私有測資/管理）、學生（公開密碼/只能看公開測資與題目/上傳程式）。教師在打包時設定密碼並編譯，密碼變更需重新編譯 — 此模式已明確。
- 主要工作流程：教師打包（題目 PDF、public、private、metadata、編譯腳本），產出封裝檔；考場在本地 VM 做批改（private 測資在 VM 中解密並執行）；學生可用公開密碼解開公開內容並在本地（或由 VM）提交程式。
- 封裝內容與檔案命名規則：`public/` / `private/`、檔案以編號命名、`.in` / `.out` 規則已定。
- 隱私擦除接受「寫暫存檔並立即覆寫刪除」：實作上我們可以在暫存檔寫入後用覆寫再刪除，並建議用 tmpfs（RAM）暫存以降低磁碟殘留風險（若環境允許）。
- 沙箱：目前不需要在應用層沙箱，因為您會在受控 VM 中執行批改；因此設計可以假定批改過程在隔離的 VM 環境內進行（系統設計不強制實作容器化）。
- 並發性與部署：每台機器單一使用者（無同時多學生），可用簡單單執行序設計。
- 日誌：需要保留批改結果日誌（僅紀錄結果，不包含隱藏輸出），該需求已明確。
- UI：CLI 足夠（後續可擴 GUI）。
- 版本/工具支援：必須支援 C++17、lex、yacc，並用您提供的 student lex 編譯腳本作為參考（範例已提供）。
- 發佈形式：單一靜態二進位檔（statically linked）為目標。

**仍需您簡短確認／尚未完全決定的項目**

1. 編譯器來源（您在問題 9 留白）：要我假設並設計為「使用目標系統上已安裝的系統編譯器（g++, flex, bison）」？還是要把編譯器/工具鏈一併打包進靜態二進位發佈？  
   - 我的建議：採用系統已安裝的編譯器（較輕量、避免打包龐大 toolchain）。若您希望完全獨立，後續我們再討論 bundling 方案或 container 化。請回覆偏好。
2. 封裝/加密格式：您請我評估標準 zip 是否能達到保密要求。結論與建議在下方（請確認接受或要我另外設計自訂格式）：
   - 評估摘要：
     - 傳統 ZipCrypto（zip 密碼保護）弱、不建議用於保護私有測資。
     - AES-加密的 ZIP（WinZip AES）安全性好，但平台/工具支援可能有相容性問題（在 Unix 環境通常可用 libzip 或 7-zip 支援 AES）。若要最大相容性與可控性，建議不要完全依賴 ZIP 密碼功能。
   - 建議實作（推薦，因為滿足您的需求並易實作）：
     - 封裝流程採「兩段加密 blob」策略：把 `public/` 打包成一個 tar（或 zip）並用「公開密碼」對該 blob 做 AEAD 加密（如 AES-256-GCM）；把 `private/` 打包成另一個 tar 並用「專用密碼」加密；最後把兩個加密 blob 與 `meta.json`（未加密或只含非敏感 metadata）合成一個封裝檔（例如 `.pkg` JSON/二進位容器）。這達到：
       - 教師與學生可分別以不同密碼解密對應 blob。
       - 不需依賴 ZIP 密碼的弱點，使用通用 AEAD（OpenSSL/ libsodium）實作容易且安全。
     - 若您偏好「單一檔案兼容工具」，我們也可以選擇「zip 檔內分別存放 public.zip（加密）/private.zip（加密）/meta.json」，但要確保使用支援 AES-256 的 zip library 來產生/解密。
   - 請回覆：偏好「自訂容器 + AEAD blobs（我的推薦）」還是「zip-with-AES（兼容性考量）」？
3. 密鑰/密碼管理細節：您提到編譯時設定密碼並分發，這裡需確認：
   - 學生端是否要在執行時手動輸入公開密碼來解密公開 blob？（或打包時把公開 blob 放成未加密？）
   - 教師在 VM 上是否會事先在該 VM 上輸入專用密碼或把專用密碼寫入 VM 環境以便自動化批改？（若想自動化，需在 VM 上安全儲存/輸入密碼）
4. temporary file handling：您接受覆寫刪除，但想確認是否願意在可用時使用 `tmpfs`（更安全）或僅用覆寫刪除（較通用）。
5. 資源限制與超時：您提供建議「最多 30 對測資、3 秒超時」。我會把這設為預設但允許在 `meta.json` 中覆寫。確認同意嗎？

**我建議的具體技術選擇（供您快速決策）**

- 封裝格式：推薦「自訂容器」＝ JSON header + two AEAD-encrypted blobs (public/private tar.gz)，副檔名如 `.ldjpkg`（local domjudge pkg）。方便實作且安全性高。若您執意兼容 zip，我可改用 zip（確保使用 AES-256）。
- 加密：AES-256-GCM（或 libsodium secretbox，AEAD）。使用密碼派生鍵（PBKDF2/Argon2）再做 AEAD 加解密。
- Metadata：`meta.json`（版本、lang、compile_command、timeout_ms、tests 列表、author、timestamp）。此檔可放在容器外層未加密或只部分加密（meta 可含哪些測資是 public/private）。
- 暫存：解密後寫到 `TMPDIR`；若環境支援建議先檢查是否掛載 tmpfs，否則覆寫三輪再刪除。
- 編譯器：預設使用系統上安裝的 `g++`, `flex`, `bison`。（如需 bundling 再討論）
- CLI 介面（草案子命令）：`pack`（教師）、`unpack`（教師/學生對公開部分）、`run` 或 `grade`（在 VM 中解密 private blob 並跑測資）、`export-public`、`verify`（檔案完整性）。我可以列詳細參數與範例。
- 日誌：每次打分產出 JSON 日誌（time, user, problem, test_results[ {id, status, time_ms} ]），並將結果保存在 `logs/`。

**下一步 (我可以立刻做的項目，請選一或多項)**

- A. 生成完整技術設計草案（包含：封裝格式細節、meta.json schema、加解密演算法與命令行參數、暫存擦除策略、日誌格式、示例 CLI 指令與流程） —— 建議優先。
- B. 產生 `meta.json` 的 JSON Schema + 範例檔案（可馬上用於打包工具）。
- C. 提供 `pack/unpack` CLI 原型（命令列表與參數，非程式碼）與範例使用流程。
- D. 實作一個最小可運行的 prototype（單檔靜態 Go 或 Rust/C++ 程式）來做「pack/unpack + AES-GCM blobs」，包含 `meta.json` 範例（注意：若要靜態連結加密庫，我會選擇 Go 或 Rust 可較輕易做靜態二進位）。這會是可執行的 PoC，但需您確認使用哪種語言偏好（Go/Rust/C++）。

請先回覆：

1. 對「編譯器來源」的偏好（系統安裝 vs bundling）；  
2. 對「封裝 + 加密」偏好（推薦的自訂 AEAD-blobs vs zip-with-AES）；  
3. 是否接受我先產出完整技術設計草案（選項 A）？  
4. 是否同意把 `meta.json` 中的預設值設為：max_tests=30, timeout_per_test=3000ms（可覆寫）？

收到您確認後，我將把第4、5、6 個 TODO 項目依選擇進行並把設計草案交付。
